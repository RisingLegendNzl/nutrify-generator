<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Nutritional Planner</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom styles for a sleek look */
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }

        .card-base {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        .day-card {
             transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .day-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
        }
        .loader {
            border-top-color: #3498db;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Modal styles */
        .modal { transition: opacity 0.3s ease; }
        .modal-content { transition: transform 0.3s ease; }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 transition-colors duration-500">

    <div class="min-h-screen flex flex-col items-center p-4 lg:p-8">
        
        <!-- Header -->
        <header class="w-full max-w-[100rem] flex justify-between items-center mb-8">
            <div class="text-left">
                <h1 class="text-4xl md:text-5xl font-bold text-gray-900 dark:text-white">Advanced Planner</h1>
                <p id="subtitle" class="text-lg text-gray-600 dark:text-gray-400 mt-2">Your data-driven meal plan</p>
            </div>
            <button id="profile-btn" class="bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-200 font-bold py-2 px-4 rounded-lg flex items-center space-x-2">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.121 17.804A13.937 13.937 0 0112 16c2.5 0 4.847.655 6.879 1.804M15 10a3 3 0 11-6 0 3 3 0 016 0zm6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                <span>Profile</span>
            </button>
        </header>
        
        <!-- Weekly Summary -->
        <div id="weekly-summary-container" class="w-full max-w-[100rem] mb-8 hidden">
             <div class="card-base rounded-2xl p-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4">
                    <h2 class="text-2xl font-bold text-gray-900 dark:text-white md:col-span-2">Plan Summary</h2>
                    <div class="bg-gray-500/10 dark:bg-black/20 p-4 rounded-lg">
                        <h3 class="font-bold text-center text-lg mb-2">Your Daily Targets</h3>
                        <div id="daily-targets-summary" class="text-center text-sm"></div>
                    </div>
                    <div class="bg-gray-500/10 dark:bg-black/20 p-4 rounded-lg">
                        <h3 class="font-bold text-center text-lg mb-2">Avg. Actual Daily Intake</h3>
                        <div id="avg-actual-summary" class="text-center text-sm"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Weekly Meal Display -->
        <div id="weekly-plan-container" class="w-full max-w-[100rem] grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 xl:grid-cols-7 gap-6"></div>
        <div id="placeholder" class="w-full max-w-7xl text-center py-10 px-6 rounded-2xl day-card card-base">
            <p id="placeholder-text" class="text-gray-500 dark:text-gray-400">Loading user profile...</p>
        </div>

        <!-- Action Button -->
        <div class="mt-12">
            <button id="generate-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-full shadow-lg transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-blue-300 dark:focus:ring-blue-800 flex items-center justify-center space-x-2 w-72" disabled>
                <svg id="button-icon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h5M5 5a7 7 0 0012.248 4.752M19 20v-5h-5M20 20a7 7 0 00-12.248-4.752"></path></svg>
                <span id="button-text">Generate Full Week Plan</span>
                <div id="button-loader" class="loader w-6 h-6 rounded-full border-4 border-t-4 border-gray-200 hidden"></div>
            </button>
        </div>
    </div>

    <!-- Modals -->
    <div id="profile-modal" class="modal fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden opacity-0" onclick="closeModal('profile-modal')">
        <div class="modal-content card-base bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto transform scale-95" onclick="event.stopPropagation()">
            <div class="p-8">
                <h2 class="text-3xl font-bold text-gray-900 dark:text-white mb-6">Your Profile</h2>
                <form id="profile-form" class="space-y-4">
                    <!-- Personal Details -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="age" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Age</label>
                            <input type="number" id="age" class="mt-1 w-full p-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md" required>
                        </div>
                        <div>
                            <label for="sex" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Sex</label>
                            <select id="sex" class="mt-1 w-full p-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md">
                                <option value="male">Male</option>
                                <option value="female">Female</option>
                            </select>
                        </div>
                         <div>
                            <label for="height" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Height (cm)</label>
                            <input type="number" id="height" class="mt-1 w-full p-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md" required>
                        </div>
                        <div>
                            <label for="weight" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Weight (kg)</label>
                            <input type="number" id="weight" class="mt-1 w-full p-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md" required>
                        </div>
                    </div>
                    <!-- Activity Level -->
                     <div>
                        <label for="activity" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Activity Level</label>
                        <select id="activity" class="mt-1 w-full p-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md">
                            <option value="1.2">Sedentary (little or no exercise)</option>
                            <option value="1.375">Lightly active (light exercise/sports 1-3 days/week)</option>
                            <option value="1.55">Moderately active (moderate exercise/sports 3-5 days/week)</option>
                            <option value="1.725">Very active (hard exercise/sports 6-7 days a week)</option>
                            <option value="1.9">Extra active (very hard exercise/physical job)</option>
                        </select>
                    </div>
                    <!-- Goals & Macros -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 border-t border-gray-200 dark:border-gray-700 pt-4">
                        <div>
                            <label for="goal" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Fitness Goal</label>
                            <select id="goal" class="mt-1 w-full p-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md">
                                <option value="cutting">Cutting (Lose Weight)</option>
                                <option value="maintaining">Maintaining</option>
                                <option value="bulking">Bulking (Gain Weight)</option>
                            </select>
                        </div>
                        <div>
                            <label for="macros" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Macronutrient Split</label>
                            <select id="macros" class="mt-1 w-full p-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md">
                                <option value="balanced">Balanced (40C/30P/30F)</option>
                                <option value="high_protein">High Protein (30C/40P/30F)</option>
                                <option value="low_carb">Lower Carb (25C/40P/35F)</option>
                            </select>
                        </div>
                        <!-- NEW FIELD: Store Preference -->
                        <div class="md:col-span-2">
                            <label for="storePreference" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Grocery Store Preference</label>
                            <select id="storePreference" class="mt-1 w-full p-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md">
                                <option value="woolworths">Woolworths</option>
                                <option value="coles">Coles</option>
                            </select>
                        </div>
                    </div>
                    <!-- Dietary Restrictions -->
                    <div class="border-t border-gray-200 dark:border-gray-700 pt-4">
                        <p class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Dietary Requirements</p>
                        <div class="flex items-center space-x-4">
                            <label class="flex items-center"><input type="checkbox" id="vegetarian" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"> <span class="ml-2">Vegetarian</span></label>
                            <label class="flex items-center"><input type="checkbox" id="vegan" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"> <span class="ml-2">Vegan</span></label>
                        </div>
                    </div>
                    <!-- Actions -->
                    <div class="flex justify-end space-x-4 pt-4">
                        <button type="button" class="px-4 py-2 bg-gray-200 dark:bg-gray-600 rounded-md text-sm font-medium hover:bg-gray-300 dark:hover:bg-gray-500" onclick="closeModal('profile-modal')">Cancel</button>
                        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md text-sm font-medium hover:bg-blue-700">Save & Calculate</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div id="recipe-modal" class="modal fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden opacity-0" onclick="closeModal('recipe-modal')">
        <div class="modal-content card-base bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto transform scale-95" onclick="event.stopPropagation()"></div>
    </div>
    
    <!-- Custom Toast Notification Container -->
    <div id="toast-container" class="fixed bottom-4 right-4 space-y-2 z-[60]"></div>

    <script type="module">
        // --- Firebase Imports and Setup ---
        // We only import Firebase modules if the app is determined to run in a persistent environment.
        let initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore, doc, getDoc, setDoc, setLogLevel;

        // Global Firebase Variables (Provided by Canvas Environment)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // 🛑 IMPORTANT: FOR NETLIFY/PUBLIC DEPLOYMENT 🛑
        // This is a placeholder for a public Firebase config. Since you don't have one, 
        // the app will default to a local, non-persistent mode on Netlify.
        const PUBLIC_FIREBASE_CONFIG = {
            apiKey: "YOUR_API_KEY", 
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID", 
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_MESSAGING_ID",
            appId: "YOUR_PUBLIC_APP_ID"
        };
        // -----------------------------------------------------------

        let db = null;
        let auth = null;
        let userId = null;
        let isAuthReady = false;
        let isPersistentMode = false; // Flag to check if we are connected to Firestore
        let userProfileData = null; // Global profile storage

        // --- Firebase Initialization and Auth ---
        
        const initFirebase = async () => {
            const isCanvasEnvironment = typeof __firebase_config !== 'undefined';
            const isPublicConfigValid = PUBLIC_FIREBASE_CONFIG && PUBLIC_FIREBASE_CONFIG.projectId !== "YOUR_PROJECT_ID";
            
            // 1. DETERMINE MODE
            if (isCanvasEnvironment || isPublicConfigValid) {
                isPersistentMode = true;
                showToast("Persistent mode enabled: Connecting to database...", "info");
                
                // Dynamically import Firebase services only when needed
                const firebaseModules = await Promise.all([
                    import("https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js"),
                    import("https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js"),
                    import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js")
                ]);
                initializeApp = firebaseModules[0].initializeApp;
                ({ getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } = firebaseModules[1]);
                ({ getFirestore, doc, getDoc, setDoc, setLogLevel } = firebaseModules[2]);

                try {
                    const firebaseConfig = isCanvasEnvironment ? JSON.parse(__firebase_config) : PUBLIC_FIREBASE_CONFIG;
                    const app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    setLogLevel('Debug'); // Enable debug logging for Firestore

                    await new Promise((resolve) => {
                        const unsubscribe = onAuthStateChanged(auth, async (user) => {
                            if (user) {
                                userId = user.uid;
                            } else {
                                // Attempt anonymous sign-in if no user is found
                                try {
                                    await signInAnonymously(auth);
                                    userId = auth.currentUser.uid;
                                } catch (e) {
                                    console.error("Anonymous sign-in failed:", e);
                                    userId = crypto.randomUUID(); // Fallback to a random ID
                                }
                            }
                            isAuthReady = true;
                            unsubscribe(); 
                            resolve();
                        });
                    });
                    
                    if (initialAuthToken && auth.currentUser.isAnonymous) {
                         try {
                            await signInWithCustomToken(auth, initialAuthToken);
                            userId = auth.currentUser.uid;
                        } catch (e) {
                            console.error("Custom token sign-in failed, continuing anonymously:", e);
                        }
                    }
                    
                    await loadProfile();

                } catch (e) {
                    console.error("Firebase initialization failed:", e);
                    isPersistentMode = false; // Disable persistence on failure
                    isAuthReady = true;
                    showToast("Error connecting to database. Running in local mode.", "error");
                    updateUIForProfile(true);
                }

            } else {
                // 2. LOCAL NON-PERSISTENT MODE (The fix for Netlify without credentials)
                isPersistentMode = false;
                isAuthReady = true;
                userId = crypto.randomUUID(); // Mock user ID for local session tracking
                
                showToast("No database configured. App is running in local, non-persistent mode.", "error");
                updateUIForProfile(true); // Load UI immediately
            }
        };


        // --- Expanded & Tagged Meal Database (Now with Ingredients) ---
        const MEAL_DATABASE = {
            breakfasts: [
                { name: 'Porridge with Berries', calories: 350, protein: 10, carbs: 60, fat: 8, tags: ['vegetarian', 'vegan'], image: 'https://placehold.co/600x400/F4D03F/333333?text=Porridge', ingredients: ['Rolled Oats', 'Almond Milk', 'Mixed Berries', 'Cinnamon'] },
                { name: 'Two Eggs on Sourdough', calories: 400, protein: 25, carbs: 35, fat: 18, tags: ['vegetarian'], image: 'https://placehold.co/600x400/E8F8F5/333333?text=Eggs+on+Toast', ingredients: ['Eggs', 'Sourdough Bread', 'Butter', 'Salt and Pepper'] },
                { name: 'Greek Yogurt with Granola', calories: 380, protein: 20, carbs: 45, fat: 15, tags: ['vegetarian'], image: 'https://placehold.co/600x400/D6EAF8/333333?text=Yogurt', ingredients: ['Greek Yogurt', 'Granola', 'Honey', 'Walnuts'] },
                { name: 'Avocado Toast (1 slice)', calories: 280, protein: 8, carbs: 25, fat: 18, tags: ['vegetarian', 'vegan'], image: 'https://placehold.co/600x400/D5F5E3/333333?text=Avocado+Toast', ingredients: ['Wholemeal Bread', 'Avocado', 'Lime Juice', 'Chilli Flakes'] },
                { name: 'Weet-Bix with Milk & Banana', calories: 320, protein: 12, carbs: 65, fat: 4, tags: ['vegetarian'], image: 'https://placehold.co/600x400/EBDEF0/333333?text=Weet-Bix', ingredients: ['Weet-Bix', 'Dairy Milk', 'Banana', 'Sugar'] },
                { name: 'Protein Smoothie (Whey)', calories: 450, protein: 30, carbs: 50, fat: 12, tags: ['vegetarian'], image: 'https://placehold.co/600x400/F5B7B1/333333?text=Smoothie', ingredients: ['Whey Protein Powder', 'Banana', 'Spinach', 'Peanut Butter', 'Water'] },
                { name: 'Tofu Scramble', calories: 330, protein: 22, carbs: 15, fat: 20, tags: ['vegetarian', 'vegan'], image: 'https://placehold.co/600x400/F9E79F/333333?text=Tofu+Scramble', ingredients: ['Firm Tofu', 'Turmeric Powder', 'Nutritional Yeast', 'Onion', 'Bell Peppers'] },
            ],
            mainMeals: [
                { name: 'Chicken Breast & Veggies', calories: 450, protein: 50, carbs: 20, fat: 20, tags: [], image: 'https://placehold.co/600x400/A3E4D7/333333?text=Chicken+Breast', ingredients: ['Chicken Breast Fillets', 'Broccoli Florets', 'Carrots', 'Olive Oil', 'Garlic Powder'] },
                { name: 'Chicken Stir-fry with Rice', calories: 550, protein: 40, carbs: 60, fat: 15, tags: [], image: 'https://placehold.co/600x400/A2D9CE/333333?text=Chicken+Stir-fry', ingredients: ['Chicken Thigh', 'Soy Sauce', 'Mixed Frozen Vegetables', 'Rice', 'Ginger'] },
                { name: 'Spaghetti Bolognese', calories: 600, protein: 35, carbs: 70, fat: 20, tags: [], image: 'https://placehold.co/600x400/E59866/333333?text=Bolognese', ingredients: ['Beef Mince', 'Spaghetti Pasta', 'Tomato Paste', 'Onion', 'Parmesan Cheese'] },
                { name: 'Steak with Salad & Chips', calories: 700, protein: 50, carbs: 40, fat: 38, tags: [], image: 'https://placehold.co/600x400/D98880/333333?text=Steak', ingredients: ['Rump Steak', 'Potatoes', 'Mixed Salad Leaves', 'Dressing'] },
                { name: 'Beef Stew with Bread', calories: 580, protein: 45, carbs: 55, fat: 22, tags: [], image: 'https://placehold.co/600x400/C39BD3/333333?text=Beef+Stew', ingredients: ['Diced Beef', 'Beef Stock', 'Carrots', 'Potatoes', 'Crusty Bread'] },
                { name: 'Grilled Salmon & Asparagus', calories: 500, protein: 45, carbs: 10, fat: 32, tags: [], image: 'https://placehold.co/600x400/AED6F1/333333?text=Salmon', ingredients: ['Salmon Fillets', 'Asparagus', 'Lemon', 'Salt', 'Black Pepper'] },
                { name: 'Tuna Pasta Bake', calories: 580, protein: 30, carbs: 75, fat: 18, tags: [], image: 'https://placehold.co/600x400/A569BD/333333?text=Tuna+Bake', ingredients: ['Canned Tuna', 'Pasta Shells', 'Cream Sauce', 'Cheese', 'Peas'] },
                { name: 'Lentil Soup with Bread', calories: 450, protein: 20, carbs: 80, fat: 5, tags: ['vegetarian', 'vegan'], image: 'https://placehold.co/600x400/A9DFBF/333333?text=Lentil+Soup', ingredients: ['Brown Lentils', 'Vegetable Stock', 'Diced Tomatoes', 'Carrots', 'Bread Rolls'] },
                { name: 'Vegetable Curry with Rice', calories: 520, protein: 15, carbs: 85, fat: 12, tags: ['vegetarian', 'vegan'], image: 'https://placehold.co/600x400/F9E79F/333333?text=Veg+Curry', ingredients: ['Potatoes', 'Cauliflower', 'Coconut Milk', 'Curry Powder', 'Basmati Rice'] },
                { name: 'Tofu Stir-fry with Noodles', calories: 500, protein: 25, carbs: 65, fat: 15, tags: ['vegetarian', 'vegan'], image: 'https://placehold.co/600x400/F5CBA7/333333?text=Tofu+Stir-fry', ingredients: ['Firm Tofu', 'Soy Noodles', 'Broccoli', 'Soy Sauce', 'Sesame Oil'] },
                { name: 'Lamb Chops with Roast Veg', calories: 680, protein: 45, carbs: 35, fat: 40, tags: [], image: 'https://placehold.co/600x400/D2B4DE/333333?text=Lamb+Chops', ingredients: ['Lamb Chops', 'Rosemary', 'Sweet Potato', 'Zucchini', 'Olive Oil'] },
                { name: 'Chicken Schnitzel & Salad', calories: 600, protein: 40, carbs: 40, fat: 30, tags: [], image: 'https://placehold.co/600x400/85C1E9/333333?text=Schnitzel', ingredients: ['Chicken Breast', 'Bread Crumbs', 'Eggs', 'Salad Mix', 'Mayonnaise'] },
                { name: 'Caesar Salad with Chicken', calories: 480, protein: 40, carbs: 15, fat: 30, tags: [], image: 'https://placehold.co/600x400/82E0AA/333333?text=Caesar+Salad', ingredients: ['Cos Lettuce', 'Chicken Strips', 'Bacon', 'Croutons', 'Caesar Dressing'] },
                { name: 'Chickpea & Spinach Curry', calories: 480, protein: 18, carbs: 70, fat: 14, tags: ['vegetarian', 'vegan'], image: 'https://placehold.co/600x400/F7DC6F/333333?text=Chickpea+Curry', ingredients: ['Canned Chickpeas', 'Spinach', 'Curry Paste', 'Canned Tomatoes', 'Onion'] },
                { name: 'Black Bean Burgers', calories: 550, protein: 25, carbs: 60, fat: 23, tags: ['vegetarian', 'vegan'], image: 'https://placehold.co/600x400/B2BABB/333333?text=Bean+Burger', ingredients: ['Canned Black Beans', 'Burger Buns', 'Lettuce', 'Tomato', 'Sauce'] },
            ]
        };

        const MACRO_SPLITS = {
            balanced: { c: 0.40, p: 0.30, f: 0.30 },
            high_protein: { c: 0.30, p: 0.40, f: 0.30 },
            low_carb: { c: 0.25, p: 0.40, f: 0.35 }
        };
        
        // Define store search URL builders
        const STORE_SEARCH_URLS = {
            woolworths: (term) => `https://www.woolworths.com.au/shop/search/products?searchTerm=${encodeURIComponent(term)}`,
            coles: (term) => `https://www.coles.com.au/search?query=${encodeURIComponent(term)}`
        };


        // DOM Elements
        const generateBtn = document.getElementById('generate-btn');
        const weeklyPlanContainer = document.getElementById('weekly-plan-container');
        const placeholder = document.getElementById('placeholder');
        const placeholderText = document.getElementById('placeholder-text');
        const subtitle = document.getElementById('subtitle');
        const profileBtn = document.getElementById('profile-btn');
        const weeklySummaryContainer = document.getElementById('weekly-summary-container');

        // Profile Form Inputs
        const profileForm = document.getElementById('profile-form');
        const formInputs = {
            age: document.getElementById('age'),
            sex: document.getElementById('sex'),
            height: document.getElementById('height'),
            weight: document.getElementById('weight'),
            activity: document.getElementById('activity'),
            goal: document.getElementById('goal'),
            macros: document.getElementById('macros'),
            storePreference: document.getElementById('storePreference'),
            vegetarian: document.getElementById('vegetarian'),
            vegan: document.getElementById('vegan')
        };
        
        // --- Utility Functions ---

        const getProfileDocRef = () => {
            if (!db || !userId) return null;
            // Private Data Path: /artifacts/{appId}/users/{userId}/plannerData/profileDoc
            return doc(db, 'artifacts', appId, 'users', userId, 'plannerData', 'profileDoc');
        };

        const showToast = (message, type = 'info') => {
            const container = document.getElementById('toast-container');
            const color = type === 'error' ? 'bg-red-500' : type === 'success' ? 'bg-green-500' : 'bg-blue-500';

            const toast = document.createElement('div');
            toast.className = `p-3 rounded-lg shadow-xl text-white ${color} transition-all duration-300 transform translate-y-2 opacity-0 text-sm`;
            toast.textContent = message;

            container.appendChild(toast);

            // Animate in
            setTimeout(() => {
                toast.classList.remove('translate-y-2', 'opacity-0');
            }, 10);

            // Animate out and remove
            setTimeout(() => {
                toast.classList.add('translate-y-2', 'opacity-0');
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        };

        // --- Core Logic ---
        
        const calculateTargets = (profile) => {
            const { age, sex, height, weight, activity, goal, macros } = profile;
            // Mifflin-St Jeor Equation for BMR
            const bmr = (10 * weight) + (6.25 * height) - (5 * age) + (sex === 'male' ? 5 : -161);
            const tdee = bmr * activity;
            
            let calorieTarget = tdee;
            if (goal === 'cutting') calorieTarget -= 500;
            if (goal === 'bulking') calorieTarget += 500;
            
            const split = MACRO_SPLITS[macros];
            const proteinTarget = Math.round((calorieTarget * split.p) / 4);
            const carbsTarget = Math.round((calorieTarget * split.c) / 4);
            const fatTarget = Math.round((calorieTarget * split.f) / 9);

            return { calorieTarget: Math.round(calorieTarget), proteinTarget, carbsTarget, fatTarget };
        };

        const findBestDayPlan = (targets, filteredDb) => {
            const { calorieTarget, proteinTarget, carbsTarget } = targets;
            let bestCombination = null;
            let lowestScore = Infinity;

            // Simple randomization for variety
            const getRandomMeal = (type) => filteredDb[type][Math.floor(Math.random() * filteredDb[type].length)];

            for (let i = 0; i < 250; i++) { // Increase attempts for better optimization
                const breakfast = getRandomMeal('breakfasts');
                const lunch = getRandomMeal('mainMeals');
                const dinner = getRandomMeal('mainMeals');

                if (lunch.name === dinner.name) continue; // Ensure variety

                const totalCals = breakfast.calories + lunch.calories + dinner.calories;
                const totalProt = breakfast.protein + lunch.protein + dinner.protein;
                const totalCarbs = breakfast.carbs + lunch.carbs + dinner.carbs;

                // Score is a weighted sum of the squared errors from targets (Focus on Cals/Protein)
                const calError = ((totalCals - calorieTarget) / calorieTarget) * 100; // % error
                const protError = ((totalProt - proteinTarget) / proteinTarget) * 100;
                const carbError = ((totalCarbs - carbsTarget) / carbsTarget) * 100;

                // Give extra weight to calories and protein accuracy
                const score = (calError * calError * 3) + (protError * protError * 2) + (carbError * carbError);

                if (score < lowestScore) {
                    lowestScore = score;
                    bestCombination = { breakfast, lunch, dinner };
                }
            }
            // Fallback: If no good combination is found, return the last attempted combo or simple defaults
            if (!bestCombination) {
                 bestCombination = { breakfast: getRandomMeal('breakfasts'), lunch: getRandomMeal('mainMeals'), dinner: getRandomMeal('mainMeals') };
            }

            return bestCombination; 
        };

        const generateWeeklyPlan = () => {
            if (!userProfileData) {
                showToast("Please complete your profile first.", "error");
                return;
            }
            if (!isAuthReady) {
                 showToast("Application is not ready. Please wait a moment.", "error");
                 return;
            }

            setLoading(true);
            placeholder.classList.add('hidden');
            weeklyPlanContainer.innerHTML = '';
            
            const targets = calculateTargets(userProfileData);
            
            // Filter database based on dietary needs
            let filteredBreakfasts = MEAL_DATABASE.breakfasts;
            let filteredMainMeals = MEAL_DATABASE.mainMeals;
            if (userProfileData.vegan) {
                filteredBreakfasts = filteredBreakfasts.filter(m => m.tags.includes('vegan'));
                filteredMainMeals = filteredMainMeals.filter(m => m.tags.includes('vegan'));
            } else if (userProfileData.vegetarian) {
                filteredBreakfasts = filteredBreakfasts.filter(m => m.tags.includes('vegetarian'));
                filteredMainMeals = filteredMainMeals.filter(m => m.tags.includes('vegetarian'));
            }

            if (filteredBreakfasts.length === 0 || filteredMainMeals.length < 2) {
                 displayError("Could not generate a plan. Not enough meals in the database match your dietary requirements.");
                 setLoading(false);
                 return;
            }

            const filteredDb = { breakfasts: filteredBreakfasts, mainMeals: filteredMainMeals };
            window.weeklyPlan = Array.from({ length: 7 }, () => findBestDayPlan(targets, filteredDb));
            
            displayWeeklyPlan(window.weeklyPlan);
            displayWeeklySummary(window.weeklyPlan, targets);
            setLoading(false);
        };

        // --- UI & Display ---

        const displayWeeklyPlan = (plan) => {
            const DAYS_OF_WEEK = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
            weeklyPlanContainer.innerHTML = ''; // Clear previous plan
            plan.forEach((dayPlan, index) => {
                const dayCard = document.createElement('div');
                dayCard.className = 'rounded-2xl shadow-lg overflow-hidden day-card card-base flex flex-col';
                const dailyTotal = Object.values(dayPlan).reduce((acc, meal) => {
                    acc.calories += meal.calories; acc.protein += meal.protein;
                    acc.carbs += meal.carbs; acc.fat += meal.fat;
                    return acc;
                }, { calories: 0, protein: 0, carbs: 0, fat: 0 });
                
                dayCard.innerHTML = `
                    <div class="p-4 bg-gray-900/10 dark:bg-black/20"><h2 class="text-xl font-bold text-center text-gray-900 dark:text-white">${DAYS_OF_WEEK[index]}</h2></div>
                    <div class="p-4 flex flex-col space-y-3 flex-grow">
                        ${createMealSection('Breakfast', dayPlan.breakfast, {day: index, type: 'breakfast'})}
                        ${createMealSection('Lunch', dayPlan.lunch, {day: index, type: 'lunch'})}
                        ${createMealSection('Dinner', dayPlan.dinner, {day: index, type: 'dinner'})}
                    </div>
                    <div class="p-4 mt-auto border-t border-gray-300 dark:border-gray-600/50 bg-gray-500/10 dark:bg-black/20">
                        <h3 class="font-bold text-center text-sm">Daily Totals</h3>
                        <div class="text-xs text-center mt-1">${dailyTotal.calories} kcal &bull; ${dailyTotal.protein}g P &bull; ${dailyTotal.carbs}g C &bull; ${dailyTotal.fat}g F</div>
                    </div>`;
                weeklyPlanContainer.appendChild(dayCard);
            });
        };

        const createMealSection = (title, meal, id) => {
            const imageUrl = meal.image.replace('/preview', ''); 
            return `<div>
                <p class="font-semibold text-gray-500 dark:text-gray-400 text-xs mb-1">${title}</p>
                <div class="flex items-center space-x-3 cursor-pointer p-2 rounded-lg hover:bg-gray-500/10" data-meal-id='${JSON.stringify(id)}' onclick="showRecipeModal(this.dataset.mealId)">
                    <img src="${imageUrl}" onerror="this.onerror=null;this.src='https://placehold.co/600x400/94A3B8/ffffff?text=Meal';" alt="${meal.name}" class="w-10 h-10 object-cover rounded-md flex-shrink-0">
                    <div class="flex-grow min-w-0"><h4 class="text-sm font-semibold truncate">${meal.name}</h4><p class="text-xs text-gray-500 dark:text-gray-400">${meal.calories} kcal</p></div>
                </div></div>`;
        };

        const displayWeeklySummary = (plan, targets) => {
            const totals = plan.reduce((acc, day) => {
                const dayTotal = Object.values(day).reduce((dAcc, meal) => {
                    dAcc.calories += meal.calories; dAcc.protein += meal.protein; dAcc.carbs += meal.carbs; dAcc.fat += meal.fat;
                    return dAcc;
                }, { calories: 0, protein: 0, carbs: 0, fat: 0 });
                Object.keys(dayTotal).forEach(key => acc[key] += dayTotal[key]);
                return acc;
            }, { calories: 0, protein: 0, carbs: 0, fat: 0 });

            document.getElementById('daily-targets-summary').innerHTML = `${targets.calorieTarget} kcal &bull; ${targets.proteinTarget}g P &bull; ${targets.carbsTarget}g C &bull; ${targets.fatTarget}g F`;
            document.getElementById('avg-actual-summary').innerHTML = `${Math.round(totals.calories/7)} kcal &bull; ${Math.round(totals.protein/7)}g P &bull; ${Math.round(totals.carbs/7)}g C &bull; ${Math.round(totals.fat/7)}g F`;
            weeklySummaryContainer.classList.remove('hidden');
        };

        const showRecipeModal = (id) => {
            try {
                // weeklyPlan is stored on window scope
                const { day, type } = JSON.parse(id);
                const meal = window.weeklyPlan[day][type];
                if (!meal) throw new Error("Meal not found");
                
                const imageUrl = meal.image.replace('/preview', ''); // Clean up placeholder URL
                const userStore = userProfileData?.storePreference || 'woolworths';
                const getStoreUrl = STORE_SEARCH_URLS[userStore];

                const ingredientListHTML = (meal.ingredients || []).map(ingredient => {
                    const url = getStoreUrl(ingredient);
                    return `<li class="flex justify-between items-center py-2 border-b border-gray-100 dark:border-gray-700 last:border-b-0">
                                <span class="text-gray-700 dark:text-gray-300 font-medium">${ingredient}</span>
                                <a href="${url}" target="_blank" class="text-blue-600 hover:text-blue-500 text-sm font-semibold transition-colors flex items-center space-x-1">
                                    <span>Shop at ${userStore.charAt(0).toUpperCase() + userStore.slice(1)}</span> 
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
                                </a>
                            </li>`;
                }).join('');


                document.getElementById('recipe-modal').querySelector('.modal-content').innerHTML = `
                    <div class="relative p-6 md:p-8">
                        <button class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 text-2xl" onclick="closeModal('recipe-modal')">&times;</button>
                        <img src="${imageUrl}" onerror="this.onerror=null;this.src='https://placehold.co/600x400/94A3B8/ffffff?text=Meal';" alt="${meal.name}" class="w-full h-48 object-cover rounded-lg mb-4">
                        <h3 class="text-3xl font-bold mb-4">${meal.name}</h3>
                        <h3 class="text-xl font-semibold border-b border-gray-300 dark:border-gray-600 pb-2 mb-3">Nutritional Information (Approx.)</h3>
                        <div class="grid grid-cols-2 gap-2 text-sm">
                           <p><b>Calories:</b> ${meal.calories} kcal</p><p><b>Protein:</b> ${meal.protein} g</p>
                           <p><b>Carbs:</b> ${meal.carbs} g</p><p><b>Fat:</b> ${meal.fat} g</p>
                        </div>
                        <h3 class="text-xl font-semibold border-b border-gray-300 dark:border-gray-600 pb-2 mb-3 mt-6">Ingredients & Shopping List</h3>
                        <ul class="divide-y divide-gray-200 dark:divide-gray-700">
                           ${ingredientListHTML}
                        </ul>
                        <p class="mt-4 text-xs text-gray-500 dark:text-gray-400">Links open to your preferred store's search results.</p>
                    </div>`;
                openModal('recipe-modal');
            } catch (e) {
                console.error("Failed to show recipe modal:", e);
                showToast("Error loading recipe details.", "error");
            }
        };
        
        const displayError = (message) => {
            placeholder.classList.remove('hidden');
            weeklyPlanContainer.innerHTML = '';
            weeklySummaryContainer.classList.add('hidden');
            placeholderText.textContent = message;
        };
        
        // --- Modals & Profile Management ---

        const openModal = (id) => {
            const modal = document.getElementById(id);
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                modal.querySelector('.modal-content').classList.remove('scale-95');
            }, 10);
        };
        const closeModal = (id) => {
            const modal = document.getElementById(id);
            modal.classList.add('opacity-0');
            modal.querySelector('.modal-content').classList.add('scale-95');
            setTimeout(() => modal.classList.add('hidden'), 300);
        };

        const saveProfile = async () => {
            const profileData = {
                age: parseInt(formInputs.age.value),
                sex: formInputs.sex.value,
                height: parseInt(formInputs.height.value),
                weight: parseInt(formInputs.weight.value),
                activity: parseFloat(formInputs.activity.value),
                goal: formInputs.goal.value,
                macros: formInputs.macros.value,
                storePreference: formInputs.storePreference.value,
                vegetarian: formInputs.vegetarian.checked,
                vegan: formInputs.vegan.checked
            };
            
            if(profileData.vegan) profileData.vegetarian = true; // Vegan is also vegetarian
            
            userProfileData = profileData;

            if (!isPersistentMode) {
                // LOCAL MODE: Save to local variable only
                updateUIForProfile(true);
                closeModal('profile-modal');
                showToast("Profile saved locally (data will not persist on refresh).", "success");
                return;
            }

            // PERSISTENT MODE: Save to Firestore
            if (!isAuthReady || !db) {
                showToast("Cannot save profile. Database connection is not ready.", "error");
                return;
            }
            
            try {
                const docRef = getProfileDocRef();
                await setDoc(docRef, profileData);
                updateUIForProfile(true);
                closeModal('profile-modal');
                showToast("Profile saved successfully to Firestore!", "success");
            } catch (e) {
                console.error("Error saving profile to Firestore: ", e);
                showToast("Error saving profile. Please check the console.", "error");
            }
        };

        const loadProfile = async () => {
            if (!isAuthReady) return;

            if (!isPersistentMode) {
                // LOCAL MODE: No loading needed, userProfileData starts as null
                updateUIForProfile(true);
                return;
            } 

            // PERSISTENT MODE: Load from Firestore
            try {
                const docRef = getProfileDocRef();
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    userProfileData = docSnap.data();
                    showToast("Profile loaded from Firestore.", "info");
                } else {
                    userProfileData = null;
                    showToast("No saved profile found. Please enter your details.", "info");
                }
                
                updateUIForProfile(true);

            } catch (e) {
                console.error("Error loading profile from Firestore: ", e);
                showToast("Error loading profile. Starting with default settings.", "error");
                updateUIForProfile(true); 
            }
        };

        const updateUIForProfile = (isReady) => {
            placeholderText.textContent = 'Loading user profile...';
            generateBtn.disabled = true;
            
            if (!isReady) return;

            if (userProfileData) {
                // Populate form fields with loaded data
                Object.keys(formInputs).forEach(key => {
                    if (formInputs[key].type === 'checkbox') {
                        formInputs[key].checked = userProfileData[key] || false;
                    } else if (userProfileData[key] !== undefined) {
                        formInputs[key].value = userProfileData[key];
                    }
                });

                const goalText = userProfileData.goal.charAt(0).toUpperCase() + userProfileData.goal.slice(1);
                
                if (isPersistentMode) {
                   subtitle.textContent = `Goal: ${goalText} | User ID: ${userId.slice(0, 4)}...`;
                } else {
                   subtitle.textContent = `Goal: ${goalText} | Running in LOCAL (non-persistent) Mode`;
                }

                placeholderText.textContent = `Click the button below to generate your weekly meal plan!`;
                generateBtn.disabled = false;
            } else {
                subtitle.textContent = 'Your data-driven meal plan';
                placeholderText.textContent = 'Please complete your profile to generate a personalized meal plan.';
            }

            if (!isPersistentMode) {
                 placeholderText.textContent = placeholderText.textContent.replace('Please complete', 'Please complete (data will not be saved)');
            }
        };
        
        const setLoading = (isLoading) => {
            generateBtn.disabled = isLoading;
            document.getElementById('button-text').classList.toggle('hidden', isLoading);
            document.getElementById('button-icon').classList.toggle('hidden', isLoading);
            document.getElementById('button-loader').classList.toggle('hidden', !isLoading);
        };

        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', initFirebase);
        generateBtn.addEventListener('click', generateWeeklyPlan);
        profileBtn.addEventListener('click', () => openModal('profile-modal'));
        profileForm.addEventListener('submit', (e) => {
            e.preventDefault();
            saveProfile();
        });
        document.addEventListener('keydown', (e) => {
            if (e.key === "Escape") {
                closeModal('recipe-modal');
                closeModal('profile-modal');
            }
        });

        // Expose function to global scope for inline HTML click handler
        window.showRecipeModal = showRecipeModal; 
    </script>
</body>
</html>

